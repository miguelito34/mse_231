---
title: "tweet_analysis"
author: "Michael Spencer"
date: "10/7/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup

### Libraries
```{r}
if (!require(tidyverse)) install.packages("tidyverse")
library(tidyverse)
if (!require(lubridate)) install.packages("lubridate")
library(lubridate)
if (!require(scales)) install.packages("scales")
library(scales)
```

###  Parameters
```{r}
all_tweets_pathname <- "all_tweets_clean.tsv"
filtered_tweets_pathname <- "filtered_tweets_clean.tsv"
female_names_url <- "https://5harad.com/mse125/assets/hw1/female_names.tsv.gz"
male_names_url <- "https://5harad.com/mse125/assets/hw1/male_names.tsv.gz"
```

## Load Data
```{r}
all_tweets <-
  all_tweets_pathname %>%
  read_tsv(quote = " ")

filtered_tweets <-
  filtered_tweets_pathname %>% 
  read_tsv()

female_names <-
  female_names_url %>% 
  read_tsv()

male_names <-
  male_names_url %>% 
  read_tsv()
```

## Functions

### find_gender function

Here we do simple string manipulation to try and clear the names of any numbers
and emojis under the assumption that first names only include alpha characters.
Once we have isolated estimated first names we join our tweet data with our
gender data so that we can attempt to guess the gender of users.

We make an educated guess by determining which gender a name occurs with more.
The formula used is (M(x) - F(x))/(M(x) + F(x)). For names present in the data,
this gives us a number from -1 to 1, with -1 indicating female, 0 indicating
unkown, and 1 indicating male.
```{r}
find_gender <- function(data) {
  
  data %>% 
  
    # String manipulation to isolate first names
    mutate_if(
      is.character, 
      str_replace_all,
      pattern = "[^[:alpha:]+[:space:]]", # Gets rid of non-alpha characters
      replacement = ""
    ) %>% 
    mutate_if(
      is.character,
      str_extract,
      pattern = "^[:alpha:]+" # Extracts first string
    ) %>%
    mutate_if(
      is.character,
      str_to_lower # Normalizes names to lowercase for easier joining
    ) %>%
    
    # Gives each row a unique key so that they can later be brought back
    # togther
    mutate(pair_key = as.integer(rownames(.))) %>% 
    
    # Gathers the names to minimize the amount of processing needed when
    # inferring gender, connects each name to counts, and infers gender based
    # on the formula explained above
    gather(key = "user_type", value = "name", username, og_poster) %>%
    left_join(male_names, by = "name") %>% 
    left_join(female_names, by = "name") %>% 
    mutate_at(
      vars(contains("total")),
      replace_na,
      replace = 0
    ) %>% 
    mutate(
      gender_p = (total_male - total_female)/(total_male + total_female),
      est_gender = case_when(
        gender_p < 0 ~ "female",
        gender_p == 0 ~ sample(c("female", "male"), replace = TRUE, size = 1),
        gender_p > 0 ~ "male",
        TRUE ~ "unknown"
      )
    ) %>% 
    select(-total_male, -total_female) %>% 
    
    # Collects newly created data and then spreads it out so that further
    # analysis can be done, keeping interacting user pairs together
    unite(col = "info", name, gender_p, est_gender) %>% 
    spread(key = "user_type", value = "info") %>%
    separate(
      username, 
      into = c("user_name", "user_gender_p", "user_est_gender"), 
      sep = "_"
    ) %>% 
    separate(
      og_poster, 
      into = c("og_name", "og_gender_p", "og_est_gender"), 
      sep = "_"
    ) %>% 
    select(
      date, time, user_name, og_name, user_est_gender, og_est_gender,
      user_gender_p, og_gender_p
    )

}
```


## Data Prep

### Prep Gender Data

Assigning twitter users to a given gender using only their names requires a
statistical strategy. In the code below, I'll do just that by determining, for
a given name, whether it is more likely to be male or female. Much of this
computation will be done in the following steps once we identify the users
first name, but the first step is to identify the range of years we would like
to use before aggregating the total count of each name for each gender.

Let's assume that no twitter user is older than 90 (let's face it, not many 90
year olds are tech savvy). Let's also assume that no one younger than 5 is
Tweeting.

This means our Twitter users are between 5 and 90, and were thus born between
1928 and 2014. I'll filter out data to reflect that, while simultaneously
aggregating the names and making them lowercase (to ensure our matching of
twitter users' names is robust to capitalization).
```{r}
male_names <-
  male_names %>% 
  filter(year >= 1928 & year <= 2014) %>% 
  mutate(name = name %>% str_to_lower()) %>% 
  group_by(name) %>% 
  summarise(total_male = sum(count, na.rm = TRUE))

female_names <-
  female_names %>% 
  filter(year >= 1928 & year <= 2014) %>% 
  mutate(name = name %>% str_to_lower()) %>% 
  group_by(name) %>% 
  summarise(total_female = sum(count, na.rm = TRUE))
```

### Prep Tweet Data

We use the *find_gender( )* function written above to prep our tweet data for homophily and time analysis.

This approach is limited in that it assumes first names appear first in
multi-element strings; is implementing a simple binary classifer (of sorts)
which is not guaranteed to be perfect; and we also have no way of classifying
names with non-english characters.
```{r}
filtered_tweets_gen <- find_gender(filtered_tweets)
all_tweets_gen <- find_gender(all_tweets)
```

## Analysis

### Gender Trends Over Time

*Tweet Volume by Gender for All Tweets*
```{r}
all_tweets_plot <-
  all_tweets_gen %>% 
  filter(user_est_gender != "unknown") %>% 
  count(date, time, user_est_gender, name = "tweets") %>% 
  arrange(date, time, user_est_gender) %>% 
  transmute(
    user_est_gender = user_est_gender %>% str_to_title(), 
    tweets, 
    datetime = ymd_hms(str_c(date, time))
  ) %>% 
  ggplot(aes(datetime, tweets, color = user_est_gender)) +
  geom_line() +
  scale_x_datetime(
    breaks = "3 hours",
    date_labels = "%a, %b%e %I%p"
  ) +
  scale_y_continuous(
    labels = comma_format()
  ) +
  labs(
    title = "Tweet Volume by Gender for All Tweets",
    x = NULL,
    y = "Tweet Volume",
    caption = "Data collected from Twitter over 24 hours."
  ) +
  theme_minimal() +
  theme(
    legend.title = element_blank(),
    legend.position = "bottom",
    axis.text.x.bottom = element_text(angle = 45, hjust = 1)
  )

all_tweets_plot
```

```{r}
ggsave(plot = all_tweets_plot, file = "all_tweets_plot.pdf", width = 8, height = 5)
```

*Tweet Volume by Gender for Tweets About Greta Thunberg*
```{r}
filtered_tweets_plot <-
  filtered_tweets_gen %>% 
  filter(user_est_gender != "unknown") %>% 
  count(date, time, user_est_gender, name = "tweets") %>% 
  arrange(date, time, user_est_gender) %>% 
  transmute(
    user_est_gender = user_est_gender %>% str_to_title(), 
    tweets, 
    datetime = ymd_hms(str_c(date, time))
  ) %>% 
  ggplot(aes(datetime, tweets, color = user_est_gender)) +
  geom_line() +
  scale_x_datetime(
    breaks = "3 hours",
    date_labels = "%a, %b%e %I%p"
  ) +
  scale_y_continuous(
    labels = comma_format()
  ) +
  labs(
    title = "Tweet Volume by Gender for Tweets About Greta Thunberg",
    x = NULL,
    y = "Tweet Volume",
    caption = "Data collected from Twitter over 24 hours."
  ) +
  theme_minimal() +
  theme(
    legend.title = element_blank(),
    legend.position = "bottom",
    axis.text.x.bottom = element_text(angle = 45, hjust = 1)
  )

filtered_tweets_plot
```

```{r}
ggsave(plot = filtered_tweets_plot, file = "filtered_tweets_plot.pdf", width = 8, height = 5)
```

### Homophily

*Gender Homophily in All Tweets*

Our goal here is to see if users of one gender retweet users of the same gender
more often than they do users of a opposite gender. To test this we will use
a test similar to the one used above, in which the formula is:

(retweets of males - retweets of females)/(total retweets)

This formula will return a value from -1 to 1, with -1 indicating that females
were retweeted more and 1 indicating that males were retweeted more. Gender
homophily is evident if females get a negative score and males get a positive
score, with more polarized scores indicating more extreme homophily.
```{r}
all_tweets_gen %>% 
  filter(user_est_gender != "unknown" & og_est_gender != "unknown") %>% 
  count(user_est_gender, og_est_gender, name = "total") %>% 
  spread(key = "og_est_gender", value = "total") %>% 
  mutate(
    bias = (male - female)/(male + female),
    homophily = ifelse(bias < 0, "female", "male"),
    male_likelihood = (male - female)/male
  )
```

*Gender Homophily in Tweets About Greta Thunberg*
```{r}
filtered_tweets_gen %>% 
  filter(user_est_gender != "unknown" & og_est_gender != "unknown") %>% 
  count(user_est_gender, og_est_gender, name = "total") %>% 
  spread(key = "og_est_gender", value = "total") %>% 
  mutate(
    bias = (male - female)/(male + female),
    homophily = ifelse(bias < 0, "female", "male"),
    male_likelihood = (male - female)/male
  )
```
